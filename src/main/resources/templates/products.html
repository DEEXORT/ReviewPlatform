<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Продукты</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:fragment="productsContent">
  <div class="container mt-4">
    <!-- Кнопка добавления -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Продукты</h2>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
        + Добавить продукт
      </button>
    </div>

    <!-- Таблица -->
    <div class="card">
      <div class="card-body">
        <table class="table table-hover">
          <thead>
          <tr>
            <th>#</th>
            <th>Наименование</th>
            <th>Категория</th>
            <th>Описание</th>
            <th>Действия</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="product, iterStat : ${products}">
            <td th:text="${iterStat.count}"></td>
            <td th:text="${product.title}"></td>
            <td>
                                <span th:if="${product.category?.name}"
                                      class="badge bg-info"
                                      th:text="${product.category.name}">
                                </span>
              <span th:unless="${product.category?.name}"
                    class="badge bg-secondary">
                                    Без категории
                                </span>
            </td>
            <td>
                                <span th:if="${product.description}"
                                      th:text="${product.description}">
                                </span>
              <span th:unless="${product.description}"
                    class="text-muted">
                                    —
                                </span>
            </td>
            <td>
              <button type="button"
                      class="btn btn-sm btn-outline-primary me-2"
                      th:data-id="${product.id}"
                      th:data-title="${product.title}"
                      th:data-description="${product.description}"
                      th:data-category-id="${product.category?.id}"
                      onclick="editProduct(this)">
                Изменить
              </button>
              <button type="button"
                      class="btn btn-sm btn-outline-danger"
                      th:data-id="${product.id}"
                      th:data-title="${product.title}"
                      onclick="showDeleteModal(this)">
                Удалить
              </button>
            </td>
          </tr>
          <tr th:if="${#lists.isEmpty(products)}">
            <td colspan="5" class="text-center text-muted py-4">
              Продукты не найдены
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Модальное окно для добавления/редактирования -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="productForm" th:action="@{/products}" method="post">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Добавить продукт</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="id" id="productId">

            <div class="mb-3">
              <label class="form-label">Наименование *</label>
              <input type="text" class="form-control" name="title" id="title" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Описание</label>
              <textarea class="form-control" name="description" id="description" rows="2"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Категория *</label>
              <select class="form-select" name="category.id" id="category" required>
                <option value="">Выберите категорию...</option>
                <option th:each="category : ${categories}"
                        th:value="${category.id}"
                        th:text="${category.name}">
                </option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Модальное окно подтверждения удаления -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Удаление продукта</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="deleteMessage">Вы уверены, что хотите удалить продукт?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <form id="deleteForm" method="post" style="display: inline;">
            <button type="submit" class="btn btn-danger">Удалить</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Для работы с модальными окнами
    let productModal = new bootstrap.Modal(document.getElementById('productModal'));
    let deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Редактирование продукта
    function editProduct(button) {
      // Получаем данные из кнопки
      const productId = button.getAttribute('data-id');
      const productTitle = button.getAttribute('data-title');
      const productDescription = button.getAttribute('data-description') || '';
      const categoryId = button.getAttribute('data-category-id') || '';

      // Заполняем форму
      document.getElementById('productId').value = productId;
      document.getElementById('title').value = productTitle;
      document.getElementById('description').value = productDescription;
      document.getElementById('category').value = categoryId;

      // Меняем заголовок
      document.getElementById('modalTitle').textContent = 'Редактировать продукт';

      // Показываем модальное окно
      productModal.show();
    }

    // Показать окно удаления
    function showDeleteModal(button) {
      const productId = button.getAttribute('data-id');
      const productTitle = button.getAttribute('data-title');

      // Меняем текст сообщения
      document.getElementById('deleteMessage').textContent =
              'Вы уверены, что хотите удалить продукт "' + productTitle + '"?';

      // Устанавливаем действие формы
      document.getElementById('deleteForm').action = '/products/delete/' + productId;

      // Показываем модальное окно
      deleteModal.show();
    }

    // Сброс формы при открытии модального окна для добавления
    document.getElementById('productModal').addEventListener('show.bs.modal', function (event) {
      // Если открываем для добавления (а не для редактирования)
      if (!event.relatedTarget || !event.relatedTarget.hasAttribute('data-id')) {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('modalTitle').textContent = 'Добавить продукт';
      }
    });

    // Фокус на поле ввода при открытии модального окна
    document.getElementById('productModal').addEventListener('shown.bs.modal', function () {
      document.getElementById('title').focus();
    });
  </script>
</div>
</body>
</html>